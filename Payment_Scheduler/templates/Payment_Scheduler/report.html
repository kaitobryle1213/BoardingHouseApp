{% extends 'Payment_Scheduler/base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">Customer Payment Report</h2>
        <p class="text-secondary small mb-0">Overview of collected payments</p>
    </div>
    <div>
        <a href="{% url 'transfer_report' %}" class="btn btn-outline-primary me-2">
            <i class="fas fa-exchange-alt me-2"></i>Transfer History
        </a>
        <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>
</div>

<!-- Filter Section -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body bg-light">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-2">
                <label class="form-label small fw-bold text-secondary">Customer Name</label>
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="fas fa-user"></i></span>
                    <input type="text" name="customer_name" class="form-control" placeholder="Search name..." value="{{ filter_name|default:'' }}">
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label small fw-bold text-secondary">Room</label>
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="fas fa-bed"></i></span>
                    <select name="room" class="form-select">
                        <option value="">All Rooms</option>
                        {% for r in rooms %}
                            <option value="{{ r.id }}" {% if filter_room == r.id %}selected{% endif %}>
                                Room {{ r.room_number }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label small fw-bold text-secondary">Status</label>
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="fas fa-info-circle"></i></span>
                    <select name="status" class="form-select">
                        <option value="">All Status</option>
                        <option value="Paid" {% if filter_status == 'Paid' %}selected{% endif %}>Paid</option>
                        <option value="Unpaid" {% if filter_status == 'Unpaid' %}selected{% endif %}>Unpaid</option>
                        <option value="Partially Paid" {% if filter_status == 'Partially Paid' %}selected{% endif %}>Partially Paid</option>
                    </select>
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label small fw-bold text-secondary">Date Paid From</label>
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="fas fa-calendar-alt"></i></span>
                    <input type="date" name="date_from" class="form-control" value="{{ filter_date_from|default:'' }}">
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label small fw-bold text-secondary">Date Paid To</label>
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="fas fa-calendar-alt"></i></span>
                    <input type="date" name="date_to" class="form-control" value="{{ filter_date_to|default:'' }}">
                </div>
            </div>
            <div class="col-md-2 d-flex gap-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-filter me-1"></i> Filter
                </button>
                <a href="{% url 'report' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-undo"></i>
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Total Summary -->
<div class="row mb-4">
    <div class="col-md-4 ms-auto">
        <div class="card bg-primary text-white border-0 shadow-sm">
            <div class="card-body d-flex justify-content-between align-items-center p-3">
                <div>
                    <div class="small text-white-50 text-uppercase fw-bold">Total Collected</div>
                    <div class="h3 mb-0 fw-bold">₱{{ total_amount }}</div>
                </div>
                <i class="fas fa-coins fa-2x opacity-50"></i>
            </div>
        </div>
    </div>
</div>

<style>
    /* Custom Scrollbar Styling */
    .custom-scroll::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    .custom-scroll::-webkit-scrollbar-track {
        background: #f1f1f1; 
        border-radius: 4px;
    }
    .custom-scroll::-webkit-scrollbar-thumb {
        background: #c1c1c1; 
        border-radius: 4px;
    }
    .custom-scroll::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8; 
    }
    
    /* Sorting Styles */
    .sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        transition: background-color 0.2s;
    }
    .sortable:hover {
        background-color: #e2e6ea !important; /* Slightly darker than bg-light */
    }
    .sortable::after {
        content: ' \f0dc'; /* FontAwesome sort icon */
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        opacity: 0.3;
        margin-left: 5px;
        font-size: 0.8em;
    }
    .sortable.sort-asc::after {
        content: ' \f0de'; /* Sort up */
        opacity: 1;
    }
    .sortable.sort-desc::after {
        content: ' \f0dd'; /* Sort down */
        opacity: 1;
    }
</style>

<div class="card border-0 shadow-sm">
    <div class="table-responsive custom-scroll" style="max-height: 500px; overflow-y: auto;">
        <table class="table table-hover mb-0">
            <thead class="bg-light" style="position: sticky; top: 0; z-index: 1;">
                <tr>
                    <th class="ps-4 sortable" onclick="sortTable(0, 'text')">Customer Name</th>
                    <th class="sortable" onclick="sortTable(1, 'text')">Contact No.</th>
                    <th class="sortable" onclick="sortTable(2, 'text')">Parent's Name</th>
                    <th class="sortable" onclick="sortTable(3, 'room')">Room No.</th>
                    <th class="sortable" onclick="sortTable(4, 'date')">Date Entry</th>
                    <th class="sortable" onclick="sortTable(5, 'date')">Due Date</th>
                    <th class="sortable" onclick="sortTable(6, 'currency')">Cycle Paid</th>
                    <th class="sortable" onclick="sortTable(7, 'text')">Status</th>
                    <th class="sortable" onclick="sortTable(8, 'date')">Last Payment Date</th>
                    <th class="sortable" onclick="sortTable(9, 'text')">Remarks</th>
                </tr>
            </thead>
            <tbody>
                {% for r in rows %}
                <tr>
                    <td class="ps-4 fw-medium">{{ r.name }}</td>
                    <td>{{ r.contact_number|default:"-" }}</td>
                    <td>{{ r.parents_name|default:"-" }}</td>
                    <td>
                        <span class="badge bg-secondary bg-opacity-25 text-dark fw-normal">RM. #: {{ r.room_no|default:"-" }}</span>
                    </td>
                    <td>{{ r.date_entry|date:"M d, Y"|default:"-" }}</td>
                    <td>{{ r.due_date|date:"M d, Y"|default:"N/A" }}</td>
                    <td class="font-monospace fw-bold {% if r.status == 'Paid' %}text-success{% else %}text-secondary{% endif %}">₱{{ r.paid_amount }}</td>
                    <td class="fw-medium">{% if r.status %}{{ r.status }}{% else %}-{% endif %}</td>
                    <td>{{ r.date_amount_paid|date:"M d, Y"|default:"-" }}</td>
                    <td class="small text-muted fst-italic">{{ r.remarks|default:"-" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-center py-5 text-secondary">
                        <i class="fas fa-file-invoice-dollar fa-2x mb-3 d-block opacity-50"></i>
                        No payment records found for the selected criteria.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    let currentSortCol = -1;
    let currentSortDir = 'asc';

    function sortTable(colIndex, type) {
        const tableBody = document.querySelector('table tbody');
        const rows = Array.from(tableBody.rows);
        
        // Skip if no rows or only "No records" row
        if (rows.length === 0 || (rows.length === 1 && rows[0].cells.length === 1)) return;

        // Toggle sort direction
        if (currentSortCol === colIndex) {
            currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortCol = colIndex;
            currentSortDir = 'asc';
        }
        
        // Update headers immediately
        document.querySelectorAll('th.sortable').forEach((th, index) => {
            th.classList.remove('sort-asc', 'sort-desc');
            if (index === colIndex) {
                th.classList.add('sort-' + currentSortDir);
            }
        });

        // Show loading cursor
        document.body.style.cursor = 'wait';

        // Use setTimeout to allow UI update before heavy processing
        setTimeout(() => {
            // 1. Map to extract values (Schwartzian transform)
            // This reduces DOM access to O(N) instead of O(N log N)
            const mappedRows = rows.map(row => {
                const cell = row.cells[colIndex];
                const text = cell ? cell.textContent.trim() : '';
                let value;
                
                if (type === 'date') {
                    value = parseDate(text).getTime();
                } else if (type === 'currency') {
                    value = parseCurrency(text);
                } else if (type === 'room') {
                    value = parseRoom(text);
                } else {
                    value = text.toLowerCase();
                }
                
                return { row, value };
            });

            // 2. Sort the mapped array
            mappedRows.sort((a, b) => {
                const valA = a.value;
                const valB = b.value;
                
                if (valA === valB) return 0;

                if (currentSortDir === 'asc') {
                    return valA > valB ? 1 : -1;
                } else {
                    return valA < valB ? 1 : -1;
                }
            });
            
            // 3. Re-append rows using DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            mappedRows.forEach(obj => fragment.appendChild(obj.row));
            
            tableBody.appendChild(fragment);

            // Reset cursor
            document.body.style.cursor = 'default';
        }, 10);
    }

    function parseCurrency(str) {
        return parseFloat(str.replace(/[^0-9.-]+/g,"")) || 0;
    }

    function parseDate(str) {
        if (str === '-' || str === 'N/A' || !str) return new Date(0); 
        return new Date(str);
    }

    function parseRoom(str) {
        // "RM. #: 101" -> 101
        // Extract numbers
        const match = str.match(/\d+/);
        if (match) return parseInt(match[0]);
        // Handle "No Room" or other strings by returning a high number
        return str === '-' ? 999999 : str;
    }
</script>
{% endblock %}
