{% extends 'Payment_Scheduler/base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">Customer Payment Report</h2>
        <p class="text-secondary small mb-0">Overview of collected payments</p>
    </div>
    <div>
        <a href="{% url 'transfer_report' %}" class="btn btn-outline-primary me-2">
            <i class="fas fa-exchange-alt me-2"></i>Transfer History
        </a>
        <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>
</div>

<!-- Filter Section -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body bg-light">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-2">
                <label class="form-label small fw-bold text-secondary">Customer Name</label>
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="fas fa-user"></i></span>
                    <input type="text" name="customer_name" class="form-control" placeholder="Search name..." value="{{ filter_name|default:'' }}">
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label small fw-bold text-secondary">Room</label>
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="fas fa-bed"></i></span>
                    <select name="room" class="form-select">
                        <option value="">All Rooms</option>
                        {% for r in rooms %}
                            <option value="{{ r.id }}" {% if filter_room == r.id %}selected{% endif %}>
                                Room {{ r.room_number }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label small fw-bold text-secondary">Status</label>
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="fas fa-info-circle"></i></span>
                    <select name="status" class="form-select">
                        <option value="">All Status</option>
                        <option value="Paid" {% if filter_status == 'Paid' %}selected{% endif %}>Paid</option>
                        <option value="Unpaid" {% if filter_status == 'Unpaid' %}selected{% endif %}>Unpaid</option>
                        <option value="Partially Paid" {% if filter_status == 'Partially Paid' %}selected{% endif %}>Partially Paid</option>
                    </select>
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label small fw-bold text-secondary">Date Paid From</label>
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="fas fa-calendar-alt"></i></span>
                    <input type="date" name="date_from" class="form-control" value="{{ filter_date_from|default:'' }}">
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label small fw-bold text-secondary">Date Paid To</label>
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="fas fa-calendar-alt"></i></span>
                    <input type="date" name="date_to" class="form-control" value="{{ filter_date_to|default:'' }}">
                </div>
            </div>
            <div class="col-md-2 d-flex gap-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-filter me-1"></i> Filter
                </button>
                <a href="{% url 'report' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-undo"></i>
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Total Summary -->
<div class="row mb-4">
    <div class="col-md-4 ms-auto">
        <div class="card bg-primary text-white border-0 shadow-sm">
            <div class="card-body d-flex justify-content-between align-items-center p-3">
                <div>
                    <div class="small text-white-50 text-uppercase fw-bold">Total Collected</div>
                    <div class="h3 mb-0 fw-bold">₱{{ total_amount }}</div>
                </div>
                <i class="fas fa-coins fa-2x opacity-50"></i>
            </div>
        </div>
    </div>
</div>

<style>
    /* Custom Scrollbar Styling */
    .custom-scroll::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    .custom-scroll::-webkit-scrollbar-track {
        background: #f1f1f1; 
        border-radius: 4px;
    }
    .custom-scroll::-webkit-scrollbar-thumb {
        background: #c1c1c1; 
        border-radius: 4px;
    }
    .custom-scroll::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8; 
    }
    
    /* Sorting Styles */
    .sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        transition: background-color 0.2s;
    }
    .sortable:hover {
        background-color: #e2e6ea !important; /* Slightly darker than bg-light */
    }
    .sortable::after {
        content: ' \f0dc'; /* FontAwesome sort icon */
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        opacity: 0.3;
        margin-left: 5px;
        font-size: 0.8em;
    }
    .sortable.sort-asc::after {
        content: ' \f0de'; /* Sort up */
        opacity: 1;
    }
    .sortable.sort-desc::after {
        content: ' \f0dd'; /* Sort down */
        opacity: 1;
    }
    @media print {
        body * { visibility: hidden; }
        #receiptReprintArea, #receiptReprintArea * { visibility: visible; }
        #receiptReprintArea {
            position: fixed;
            left: 0;
            top: 0;
            width: 80mm;
            padding: 5mm;
            font-family: 'Courier New', Courier, monospace;
            font-size: 10pt;
            line-height: 1.2;
            color: #000;
            background: #fff;
        }
        @page {
            size: 80mm auto;
            margin: 0;
        }
    }
</style>

<div class="card border-0 shadow-sm">
    <div class="table-responsive custom-scroll" style="max-height: 500px; overflow-y: auto;">
        <table class="table table-hover mb-0">
            <thead class="bg-light" style="position: sticky; top: 0; z-index: 1;">
                <tr>
                    <th class="ps-4 sortable" onclick="sortTable(0, 'text')">Customer Name</th>
                    <th class="sortable" onclick="sortTable(1, 'text')">Contact No.</th>
                    <th class="sortable" onclick="sortTable(2, 'text')">Parent's Name</th>
                    <th class="sortable" onclick="sortTable(3, 'room')">Room No.</th>
                    <th class="sortable" onclick="sortTable(4, 'date')">Date Entry</th>
                    <th class="sortable" onclick="sortTable(5, 'date')">Due Date</th>
                    <th class="sortable" onclick="sortTable(6, 'currency')">Cycle Paid</th>
                    <th class="sortable" onclick="sortTable(7, 'text')">Status</th>
                    <th class="sortable" onclick="sortTable(8, 'date')">Last Payment Date</th>
                    <th class="sortable" onclick="sortTable(9, 'text')">Remarks</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for r in rows %}
                <tr data-customer-id="{{ r.customer_id }}">
                    <td class="ps-4 fw-medium">{{ r.name }}</td>
                    <td>{{ r.contact_number|default:"-" }}</td>
                    <td>{{ r.parents_name|default:"-" }}</td>
                    <td>
                        <span class="badge bg-secondary bg-opacity-25 text-dark fw-normal">RM. #: {{ r.room_no|default:"-" }}</span>
                    </td>
                    <td>{{ r.date_entry|date:"M d, Y"|default:"-" }}</td>
                    <td>{{ r.due_date|date:"M d, Y"|default:"N/A" }}</td>
                    <td class="font-monospace fw-bold {% if r.status == 'Paid' %}text-success{% else %}text-secondary{% endif %}">₱{{ r.paid_amount }}</td>
                    <td class="fw-medium">{% if r.status %}{{ r.status }}{% else %}-{% endif %}</td>
                    <td>{{ r.date_amount_paid|date:"M d, Y"|default:"-" }}</td>
                    <td class="small text-muted fst-italic">{{ r.remarks|default:"-" }}</td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button"
                                    class="btn btn-outline-secondary"
                                    onclick="reprintReceipt(this)"
                                    title="Reprint Receipt">
                                <i class="fas fa-print"></i>
                            </button>
                            <button type="button"
                                    class="btn btn-outline-primary"
                                    onclick="viewPaymentRecords(this)"
                                    title="View Payment Records">
                                <i class="fas fa-list-alt me-1"></i>
                                <span class="d-none d-md-inline">Records</span>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="11" class="text-center py-5 text-secondary">
                        <i class="fas fa-file-invoice-dollar fa-2x mb-3 d-block opacity-50"></i>
                        No payment records found for the selected criteria.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="receiptReprintModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body" id="receiptReprintArea">
                <div class="text-center mb-2">
                    <h5 class="mb-0 fw-bold">SAKURA BOARDING HOUSE</h5>
                    <div>Payment Receipt</div>
                </div>
                <div class="mb-2 small">
                    <div class="d-flex justify-content-between">
                        <span>Receipt #:</span><span id="rp_id"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Print Date:</span><span id="rp_print_date"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Customer:</span><span id="rp_name"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Contact:</span><span id="rp_contact"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Parent:</span><span id="rp_parent"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Room No.:</span><span id="rp_room"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Date Entry:</span><span id="rp_date_entry"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Due Date:</span><span id="rp_due_date"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Status:</span><span id="rp_status"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Amount Due:</span><span id="rp_amount_due"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Amount Paid:</span><span id="rp_paid_amount"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Change:</span><span id="rp_change"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Date Paid:</span><span id="rp_date_paid"></span>
                    </div>
                </div>
                <div class="small mt-2">
                    <div>Remarks:</div>
                    <div id="rp_remarks"></div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-primary w-100" onclick="printReprintReceipt()">Print Receipt</button>
                <button type="button" class="btn btn-link w-100 text-muted" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="paymentHistoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    Payment Records – <span id="ph_name"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="small text-muted mb-1" id="ph_summary"></div>
                <div class="small fw-semibold mb-2" id="ph_total"></div>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Due Date</th>
                                <th>Amount Due</th>
                                <th>Total Paid</th>
                                <th>Last Paid</th>
                                <th>Status</th>
                                <th class="text-center">Receipt</th>
                            </tr>
                        </thead>
                        <tbody id="ph_tbody">
                            <tr>
                                <td colspan="7" class="text-center text-muted py-3">
                                    No payment records found.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentSortCol = -1;
    let currentSortDir = 'asc';

    function sortTable(colIndex, type) {
        const tableBody = document.querySelector('table tbody');
        const rows = Array.from(tableBody.rows);
        
        // Skip if no rows or only "No records" row
        if (rows.length === 0 || (rows.length === 1 && rows[0].cells.length === 1)) return;

        // Toggle sort direction
        if (currentSortCol === colIndex) {
            currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortCol = colIndex;
            currentSortDir = 'asc';
        }
        
        // Update headers immediately
        document.querySelectorAll('th.sortable').forEach((th, index) => {
            th.classList.remove('sort-asc', 'sort-desc');
            if (index === colIndex) {
                th.classList.add('sort-' + currentSortDir);
            }
        });

        // Show loading cursor
        document.body.style.cursor = 'wait';

        // Use setTimeout to allow UI update before heavy processing
        setTimeout(() => {
            // 1. Map to extract values (Schwartzian transform)
            // This reduces DOM access to O(N) instead of O(N log N)
            const mappedRows = rows.map(row => {
                const cell = row.cells[colIndex];
                const text = cell ? cell.textContent.trim() : '';
                let value;
                
                if (type === 'date') {
                    value = parseDate(text).getTime();
                } else if (type === 'currency') {
                    value = parseCurrency(text);
                } else if (type === 'room') {
                    value = parseRoom(text);
                } else {
                    value = text.toLowerCase();
                }
                
                return { row, value };
            });

            // 2. Sort the mapped array
            mappedRows.sort((a, b) => {
                const valA = a.value;
                const valB = b.value;
                
                if (valA === valB) return 0;

                if (currentSortDir === 'asc') {
                    return valA > valB ? 1 : -1;
                } else {
                    return valA < valB ? 1 : -1;
                }
            });
            
            // 3. Re-append rows using DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            mappedRows.forEach(obj => fragment.appendChild(obj.row));
            
            tableBody.appendChild(fragment);

            // Reset cursor
            document.body.style.cursor = 'default';
        }, 10);
    }

    function parseCurrency(str) {
        return parseFloat(str.replace(/[^0-9.-]+/g,"")) || 0;
    }

    function parseDate(str) {
        if (str === '-' || str === 'N/A' || !str) return new Date(0); 
        return new Date(str);
    }

    function parseRoom(str) {
        // "RM. #: 101" -> 101
        // Extract numbers
        const match = str.match(/\d+/);
        if (match) return parseInt(match[0]);
        // Handle "No Room" or other strings by returning a high number
        return str === '-' ? 999999 : str;
    }
    function printReprintReceipt() {
        window.print();
    }
    function reprintReceipt(button) {
        try {
            const row = button.closest('tr');
            if (!row) {
                alert('Receipt data not found.');
                return;
            }
            const cells = row.cells;
            const index = Array.prototype.indexOf.call(row.parentNode.children, row) + 1;
            const receiptId = 'R-' + index;
            const name = cells[0] ? cells[0].textContent.trim() : '';
            const contact = cells[1] ? cells[1].textContent.trim() : '';
            const parentName = cells[2] ? cells[2].textContent.trim() : '';
            const roomText = cells[3] ? cells[3].textContent.trim() : '';
            const dateEntry = cells[4] ? cells[4].textContent.trim() : '';
            const dueDate = cells[5] ? cells[5].textContent.trim() : '';
            const paidAmount = cells[6] ? cells[6].textContent.trim() : '';
            const status = cells[7] ? cells[7].textContent.trim() : '';
            const datePaid = cells[8] ? cells[8].textContent.trim() : '';
            const remarks = cells[9] ? cells[9].textContent.trim() : '';
            const area = document.getElementById('receiptReprintArea');
            if (!area) {
                alert('Receipt layout not available.');
                return;
            }
            const idEl = document.getElementById('rp_id');
            const printDateEl = document.getElementById('rp_print_date');
            const nameEl = document.getElementById('rp_name');
            const contactEl = document.getElementById('rp_contact');
            const parentEl = document.getElementById('rp_parent');
            const roomEl = document.getElementById('rp_room');
            const dateEntryEl = document.getElementById('rp_date_entry');
            const dueDateEl = document.getElementById('rp_due_date');
            const statusEl = document.getElementById('rp_status');
            const amountDueEl = document.getElementById('rp_amount_due');
            const paidAmountEl = document.getElementById('rp_paid_amount');
            const changeEl = document.getElementById('rp_change');
            const datePaidEl = document.getElementById('rp_date_paid');
            const remarksEl = document.getElementById('rp_remarks');
            if (!idEl || !printDateEl || !nameEl || !contactEl || !parentEl || !roomEl || !dateEntryEl || !dueDateEl || !statusEl || !amountDueEl || !paidAmountEl || !changeEl || !datePaidEl || !remarksEl) {
                alert('Receipt fields are not available.');
                return;
            }
            idEl.textContent = receiptId;
            printDateEl.textContent = new Date().toLocaleDateString();
            nameEl.textContent = name || '-';
            contactEl.textContent = contact || '-';
            parentEl.textContent = parentName || '-';
            roomEl.textContent = roomText || '-';
            dateEntryEl.textContent = dateEntry || '-';
            dueDateEl.textContent = dueDate || '-';
            statusEl.textContent = status || '-';
            amountDueEl.textContent = paidAmount || '-';
            paidAmountEl.textContent = paidAmount || '-';
            changeEl.textContent = '0.00';
            datePaidEl.textContent = datePaid || '-';
            remarksEl.textContent = remarks || '-';
            const modalEl = document.getElementById('receiptReprintModal');
            if (modalEl && window.bootstrap) {
                const modal = window.bootstrap.Modal.getInstance(modalEl) || new window.bootstrap.Modal(modalEl);
                modal.show();
            }
        } catch (e) {
            console.error(e);
            alert('An error occurred while preparing the receipt.');
        }
    }

    function viewPaymentRecords(button) {
        try {
            const row = button.closest('tr');
            if (!row) {
                alert('Customer data not found.');
                return;
            }
            const customerId = row.getAttribute('data-customer-id');
            if (!customerId) {
                alert('Customer identifier is missing.');
                return;
            }

            const tbody = document.getElementById('ph_tbody');
            const nameEl = document.getElementById('ph_name');
            const summaryEl = document.getElementById('ph_summary');
            const totalEl = document.getElementById('ph_total');

            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-3">
                            Loading payment records...
                        </td>
                    </tr>`;
            }
            if (nameEl) {
                nameEl.textContent = row.cells[0] ? row.cells[0].textContent.trim() : '';
            }
            if (summaryEl) summaryEl.textContent = '';
            if (totalEl) totalEl.textContent = '';

            const url = `/api/customer_payments/${customerId}/`;

            fetch(url)
                .then(res => {
                    if (!res.ok) {
                        throw new Error('Failed to load payment records.');
                    }
                    return res.json();
                })
                .then(data => {
                    if (!tbody) {
                        return;
                    }

                    const history = data.history || [];

                    let grandTotal = 0;
                    history.forEach(item => {
                        const val = parseFloat(item.total_paid || '0') || 0;
                        grandTotal += val;
                    });

                    if (nameEl && data.customer && data.customer.name) {
                        nameEl.textContent = data.customer.name;
                    }
                    if (summaryEl && data.customer) {
                        const room = data.customer.room || '-';
                        summaryEl.textContent = `Room: ${room}`;
                    }
                    if (totalEl) {
                        totalEl.textContent = `Total Amount Paid: ₱${grandTotal.toFixed(2)}`;
                    }

                    const historyModal = document.getElementById('paymentHistoryModal');
                    if (historyModal && data.customer && data.customer.id) {
                        historyModal.setAttribute('data-customer-id', data.customer.id);
                    }

                    if (history.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center text-muted py-3">
                                    No payment records found.
                                </td>
                            </tr>`;
                        return;
                    }

                    tbody.innerHTML = '';
                    history.forEach(item => {
                        const tr = document.createElement('tr');

                        const status = item.status || '';
                        let statusClass = '';
                        if (status === 'Paid') {
                            statusClass = 'text-success fw-semibold';
                        } else if (status.indexOf('Partially') !== -1) {
                            statusClass = 'text-warning fw-semibold';
                        } else if (status === 'Unpaid') {
                            statusClass = 'text-danger fw-semibold';
                        }

                        tr.setAttribute('data-due-date', item.due_date || '');

                        tr.innerHTML = `
                            <td>${item.month_label || ''}</td>
                            <td>${item.due_date || ''}</td>
                            <td>₱${item.amount_due || '0.00'}</td>
                            <td>₱${item.total_paid || '0.00'}</td>
                            <td>${item.last_paid || '-'}</td>
                            <td class="${statusClass}">${status || '-'}</td>
                            <td class="text-center">
                                <button type="button"
                                        class="btn btn-sm btn-outline-secondary"
                                        onclick="reprintHistoryReceipt(this)"
                                        title="Reprint Receipt">
                                    <i class="fas fa-print"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                })
                .catch(err => {
                    console.error(err);
                    if (tbody) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center text-danger py-3">
                                    Error loading payment records.
                                </td>
                            </tr>`;
                    }
                })
                .finally(() => {
                    const modalEl = document.getElementById('paymentHistoryModal');
                    if (modalEl && window.bootstrap) {
                        const modal = window.bootstrap.Modal.getInstance(modalEl) || new window.bootstrap.Modal(modalEl);
                        modal.show();
                    }
                });
        } catch (e) {
            console.error(e);
            alert('An error occurred while loading payment records.');
        }
    }

    function reprintHistoryReceipt(button) {
        try {
            const row = button.closest('tr');
            if (!row) {
                alert('Record data not found.');
                return;
            }
            const historyModal = document.getElementById('paymentHistoryModal');
            const customerId = historyModal ? historyModal.getAttribute('data-customer-id') : null;
            const dueDate = row.getAttribute('data-due-date');
            if (!customerId || !dueDate) {
                alert('Record identifiers are missing.');
                return;
            }

            const url = `/api/customer_payment_receipt/${customerId}/${encodeURIComponent(dueDate)}/`;

            fetch(url)
                .then(res => {
                    if (!res.ok) {
                        throw new Error('Failed to load receipt data.');
                    }
                    return res.json();
                })
                .then(data => {
                    const area = document.getElementById('receiptReprintArea');
                    if (!area) {
                        alert('Receipt layout not available.');
                        return;
                    }
                    const idEl = document.getElementById('rp_id');
                    const printDateEl = document.getElementById('rp_print_date');
                    const nameEl = document.getElementById('rp_name');
                    const contactEl = document.getElementById('rp_contact');
                    const parentEl = document.getElementById('rp_parent');
                    const roomEl = document.getElementById('rp_room');
                    const dateEntryEl = document.getElementById('rp_date_entry');
                    const dueDateEl = document.getElementById('rp_due_date');
                    const statusEl = document.getElementById('rp_status');
                    const amountDueEl = document.getElementById('rp_amount_due');
                    const paidAmountEl = document.getElementById('rp_paid_amount');
                    const changeEl = document.getElementById('rp_change');
                    const datePaidEl = document.getElementById('rp_date_paid');
                    const remarksEl = document.getElementById('rp_remarks');
                    if (!idEl || !printDateEl || !nameEl || !contactEl || !parentEl || !roomEl || !dateEntryEl || !dueDateEl || !statusEl || !amountDueEl || !paidAmountEl || !changeEl || !datePaidEl || !remarksEl) {
                        alert('Receipt fields are not available.');
                        return;
                    }

                    idEl.textContent = data.receipt_number || '';
                    printDateEl.textContent = new Date().toLocaleDateString();

                    const cust = data.customer || {};
                    nameEl.textContent = cust.name || '-';
                    contactEl.textContent = cust.contact_number || '-';
                    parentEl.textContent = cust.parents_name || '-';
                    roomEl.textContent = cust.room || '-';
                    dateEntryEl.textContent = cust.date_entry || '-';

                    dueDateEl.textContent = data.due_date || '-';
                    statusEl.textContent = data.status || '-';
                    amountDueEl.textContent = data.amount_due || '0.00';
                    paidAmountEl.textContent = data.total_paid || '0.00';
                    changeEl.textContent = data.change || '0.00';
                    datePaidEl.textContent = data.transaction_time || '-';

                    if (data.items && data.items.length) {
                        const lines = data.items.map((item, index) => {
                            const d = item.date_paid || '-';
                            const amt = item.amount_received || '0.00';
                            const r = item.remarks || '';
                            const extra = r ? ' • ' + r : '';
                            return (index + 1) + '. ' + d + ' • ₱' + amt + extra;
                        });
                        remarksEl.textContent = lines.join('\n');
                    } else {
                        remarksEl.textContent = data.remarks || '-';
                    }

                    const historyModalEl = document.getElementById('paymentHistoryModal');
                    if (historyModalEl && window.bootstrap) {
                        const historyModal = window.bootstrap.Modal.getInstance(historyModalEl) || new window.bootstrap.Modal(historyModalEl);
                        historyModal.hide();
                    }

                    const modalEl = document.getElementById('receiptReprintModal');
                    if (modalEl && window.bootstrap) {
                        const modal = window.bootstrap.Modal.getInstance(modalEl) || new window.bootstrap.Modal(modalEl);
                        modal.show();
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('An error occurred while loading the receipt.');
                });
        } catch (e) {
            console.error(e);
            alert('An error occurred while preparing the receipt.');
        }
    }
</script>
{% endblock %}
